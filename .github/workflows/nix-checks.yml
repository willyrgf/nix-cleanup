name: Nix Checks

on:
  push:
  pull_request:

jobs:
  nix_checks: 
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
    permissions:
      id-token: write
      contents: read
      pull-requests: read

    steps:
      - name: Checkout repository
        uses: actions/checkout@cd7d8d697e10461458bc61a30d094dc601a8b017 #v4

      - uses: cachix/install-nix-action@8887e596b4ee1134dae06b98d573bd674693f47c #v26
        with:
          nix_path: nixpkgs=channel:nixos-unstable
          extra_nix_config: |
            sandbox = true # force sandbox for all OS (normally disabled for macOS)

      - name: Validate shell syntax
        run: bash -n nix-cleanup.sh

      - name: Validate help output
        run: nix run --print-build-logs --show-trace '.#nix-cleanup' -- --help

      - name: Validate argument parsing
        run: |
          set +e
          nix run --print-build-logs --show-trace '.#nix-cleanup' -- --older-than bad
          status=$?
          set -e

          if [ "$status" -eq 0 ]; then
            echo "Expected --older-than bad to fail."
            exit 1
          fi

      - name: Delete a disposable store path
        run: |
          set -euo pipefail

          nix build --print-build-logs --show-trace '.#nix-cleanup'
          cleanup_bin="$(pwd)/result/bin/nix-cleanup"

          if [ ! -x "$cleanup_bin" ]; then
            echo "Expected cleanup binary at $cleanup_bin"
            exit 1
          fi

          tmp_payload="$(mktemp)"
          trap 'rm -f "$tmp_payload"' EXIT
          printf 'nix-cleanup-ci-disposable-%s\n' "$(date +%s)" > "$tmp_payload"

          store_path="$(nix-store --add "$tmp_payload")"
          echo "Created disposable store path: $store_path"

          if [ ! -e "$store_path" ]; then
            echo "Expected disposable store path to exist before cleanup."
            exit 1
          fi

          printf 'y\n' | "$cleanup_bin" "$store_path"

          if [ -e "$store_path" ]; then
            echo "Store path still exists after cleanup: $store_path"
            exit 1
          fi
