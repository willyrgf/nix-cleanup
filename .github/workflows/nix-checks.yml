name: Nix Checks

on:
  push:
  pull_request:

jobs:
  flake_checks:
    name: Flake checks (${{ matrix.os }})
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os:
          - ubuntu-latest
          - macos-latest
    permissions:
      id-token: write
      contents: read
      pull-requests: read

    steps:
      - name: Checkout repository
        uses: actions/checkout@cd7d8d697e10461458bc61a30d094dc601a8b017 #v4

      - uses: cachix/install-nix-action@8887e596b4ee1134dae06b98d573bd674693f47c #v26
        with:
          nix_path: nixpkgs=channel:nixos-unstable
          extra_nix_config: |
            sandbox = true # force sandbox for all OS (normally disabled for macOS)

      - name: Run flake checks
        run: nix flake check --print-build-logs --show-trace

  disposable_store_path:
    name: Disposable store path cleanup (ubuntu-latest)
    runs-on: ubuntu-latest
    needs: flake_checks
    permissions:
      id-token: write
      contents: read
      pull-requests: read
    steps:
      - name: Checkout repository
        uses: actions/checkout@cd7d8d697e10461458bc61a30d094dc601a8b017 #v4

      - uses: cachix/install-nix-action@8887e596b4ee1134dae06b98d573bd674693f47c #v26
        with:
          nix_path: nixpkgs=channel:nixos-unstable
          extra_nix_config: |
            sandbox = true # force sandbox for all OS (normally disabled for macOS)

      - name: Delete a disposable store path
        run: |
          set -euo pipefail

          nix build --print-build-logs --show-trace '.#nix-cleanup'
          cleanup_bin="$(pwd)/result/bin/nix-cleanup"

          if [ ! -x "$cleanup_bin" ]; then
            echo "Expected cleanup binary at $cleanup_bin"
            exit 1
          fi

          fixture_expr="let pkgs = import <nixpkgs> {}; in pkgs.runCommand \"nix-cleanup-ci-fixture\" {} \"echo fixture > \\$out\""
          nix build --print-build-logs --show-trace --impure --out-link ci-gc-fixture --expr "$fixture_expr"

          store_path="$(readlink -f ci-gc-fixture)"
          rm -f ci-gc-fixture
          echo "Created disposable store path: $store_path"

          if [ ! -e "$store_path" ]; then
            echo "Expected disposable store path to exist before cleanup."
            exit 1
          fi

          echo "Roots before cleanup:"
          nix-store --query --roots "$store_path" || true

          if ! nix-store --gc --print-dead | grep -Fx "$store_path" > /dev/null; then
            echo "Fixture store path is not dead before cleanup."
            exit 1
          fi

          for attempt in 1 2 3; do
            "$cleanup_bin" --yes "$store_path"
            if [ ! -e "$store_path" ]; then
              break
            fi

            echo "Store path still exists after attempt $attempt. Current roots:"
            nix-store --query --roots "$store_path" || true
            sleep 1
          done

          if [ -e "$store_path" ]; then
            echo "Store path still exists after cleanup: $store_path"
            echo "Final roots:"
            nix-store --query --roots "$store_path" || true
            exit 1
          fi
